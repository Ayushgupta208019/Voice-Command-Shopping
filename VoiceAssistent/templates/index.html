<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üé§ Voice Shopping Assistant</title>
  <style>
    body {font-family: Arial,sans-serif;display:flex;height:100vh;margin:0;background:#f7f8fa;}
    #left,#right{flex:1;padding:20px;overflow-y:auto;}
    h2{margin-top:0}
    button{padding:8px 12px;margin:5px;cursor:pointer;border:none;border-radius:5px;background:#007bff;color:white;}
    button:hover{background:#0056b3;}
    .suggestion-box{border:1px solid #ccc;padding:10px;margin-top:10px;background:white;border-radius:6px;}
    .suggestion-box p{margin:4px 0;cursor:pointer;}
    .suggestion-box p:hover{background:#eee;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border:1px solid #ccc;padding:8px;text-align:center;}
    tfoot td{font-weight:bold;background:#f4f4f4;}
    .qty-btn{padding:4px 8px;margin:0 2px;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;}
    .qty-btn:hover{background:#0056b3;}
    #checkoutBtn{background:green;}
    #checkoutBtn:hover{background:darkgreen;}
    #checkoutMsg{color:blue;font-weight:bold;margin-top:10px;}
    #historyBox{margin-top:20px;border:1px solid #ccc;padding:10px;background:white;border-radius:6px;}
    #historyBox h3{margin-top:0}
    #historyList p{margin:5px 0;}
  </style>
</head>
<body>
  <div id="left">
    <h2>üé§ Voice Assistant</h2>
    <button id="recordBtn">Start Recording</button>
    <div id="output"></div>
    <div class="suggestion-box"><h3>Suggestions</h3><div id="suggestions"></div></div>
    <div class="suggestion-box"><h3>All Products</h3>
      <table id="productTable">
        <thead><tr><th>Product</th><th>Price</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="right">
    <h2>üõí Shopping Cart</h2>
    <table id="cartTable">
      <thead><tr><th>Product</th><th>Price</th><th>Qty</th><th>Action</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><td colspan="3" style="text-align:right">Total:</td><td id="cartTotal">$0.00</td></tr></tfoot>
    </table>
    <!-- ‚úÖ Checkout button -->
    <button id="checkoutBtn">‚úÖ Checkout</button>
    <div id="checkoutMsg"></div>

    <!-- ‚úÖ Checkout History -->
    <div id="historyBox">
      <h3>üìú Checkout History</h3>
      <div id="historyList"></div>
      <!-- ‚úÖ Clear history button -->
      <button id="clearHistoryBtn">üßπ Clear History</button>
    </div>
  </div>

<script>
const BACKEND = "http://127.0.0.1:5000";   // relative path ‚Üí works locally & on PythonAnywhere
const recordBtn = document.getElementById("recordBtn");
const outputDiv = document.getElementById("output");
const suggestionsDiv = document.getElementById("suggestions");
const productTable = document.querySelector("#productTable tbody");

// --- Utility: read current total from UI (before checkout) ---
function getCartTotalFromUI(){
  const txt = document.getElementById("cartTotal").textContent || "$0.00";
  const num = parseFloat(txt.replace(/[^0-9.]/g,''));
  return isNaN(num) ? 0 : num;
}

// --- Checkout History (localStorage) ---
function loadHistory(){
  const history = JSON.parse(localStorage.getItem("checkoutHistory") || "[]");
  const historyList = document.getElementById("historyList");
  historyList.innerHTML="";
  history.forEach(h=>{
    const p = document.createElement("p");
    p.textContent = `üóìÔ∏è ${h.date} - üí∞ $${h.amount}`;
    historyList.appendChild(p);
  });
}

function saveHistory(amount){
  const history = JSON.parse(localStorage.getItem("checkoutHistory") || "[]");
  const now = new Date();
  const entry = {
    date: now.toLocaleString(),
    amount: Number(amount).toFixed(2)
  };
  history.push(entry);
  localStorage.setItem("checkoutHistory", JSON.stringify(history));
  loadHistory();
}

document.getElementById("clearHistoryBtn").addEventListener("click", ()=>{
  localStorage.removeItem("checkoutHistory");
  loadHistory();
});

// Load products
async function refreshProducts(){
  const res = await fetch(`${BACKEND}/products`);
  const data = await res.json();
  productTable.innerHTML="";
  data.products.forEach(p=>{
    const row=document.createElement("tr");
    row.innerHTML=`<td>${p.title}</td><td>$${p.price}</td>`;
    productTable.appendChild(row);
  });
}

// Load cart
async function refreshCart(){
  const res = await fetch(`${BACKEND}/cart`);
  const data = await res.json();
  const tbody = document.querySelector("#cartTable tbody");
  tbody.innerHTML="";
  let total = 0;
  data.cart.forEach(item=>{
    const subtotal = item.price * (item.quantity || 1);
    total += subtotal;
    const row=document.createElement("tr");
    row.innerHTML=`
      <td>${item.title}</td>
      <td>$${subtotal.toFixed(2)}</td>
      <td>${item.quantity || 1}</td>
      <td>
        <button class="qty-btn" onclick="updateCart('add','${item.title}')">+</button>
        <button class="qty-btn" onclick="updateCart('remove','${item.title}')">-</button>
      </td>`;
    tbody.appendChild(row);
  });
  document.getElementById("cartTotal").textContent = `$${total.toFixed(2)}`;
  return total;
}

// Update cart via voice command API
async function updateCart(action,item){
  await fetch(`${BACKEND}/process_voice`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({text:`${action} ${item}`})
  });
  refreshCart();
}

// ‚úÖ Checkout button logic (save total BEFORE calling backend)
document.getElementById("checkoutBtn").addEventListener("click", async ()=>{
  const totalBefore = getCartTotalFromUI();    // <-- read from UI first
  const res = await fetch(`${BACKEND}/checkout`,{method:"POST"});
  const data = await res.json();
  document.getElementById("checkoutMsg").textContent = data.message || "Checkout done!";
  if (totalBefore > 0) saveHistory(totalBefore);
  refreshCart();
});

// Voice recognition
window.SpeechRecognition=window.SpeechRecognition||window.webkitSpeechRecognition;
if(window.SpeechRecognition){
  const recog=new SpeechRecognition();
  recog.lang="en-US";recog.interimResults=false;
  recordBtn.addEventListener("click",()=>{
    outputDiv.innerHTML="<p>üé§ Listening...</p>";recog.start();
  });
  recog.onresult=async e=>{
    const spoken=e.results[0][0].transcript;
    outputDiv.innerHTML=`<p>You said: ${spoken}</p>`;
    const res=await fetch(`${BACKEND}/process_voice`,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({text:spoken})
    });
    const data=await res.json();

    if(data.intent==="find" && data.suggestions){
      suggestionsDiv.innerHTML=data.suggestions.map(s=>`<p>${s}</p>`).join("");
    }

    // ‚úÖ If voice said "checkout", save current UI total BEFORE refreshing
    if(data.intent==="checkout"){
      const totalBefore = getCartTotalFromUI();
      document.getElementById("checkoutMsg").textContent=data.message || "Checkout done!";
      if (totalBefore > 0) saveHistory(totalBefore);
    }

    // Now refresh cart (server cart is already cleared on checkout)
    refreshCart();
  };
}else{
  outputDiv.innerHTML="<p style='color:red'>‚ùå SpeechRecognition not supported</p>";
}

// Init
refreshProducts();
refreshCart();
loadHistory();
</script>
</body>
</html>
